<script>

  class Dep {
    constructor() {
      this.subscribers = []
    }
    depend() {
      if (target && !this.subscribers.includes(target)){
        this.subscribers.push(target)
      }
    }
    notyfy() {
      this.subscribers.forEach(sub => sub())
    }
  }
  let deps = new Map()


  let data = { price: 5, quantity: 2 }
  let total, target, salePrice;

  Object.keys(data).forEach(key => {
      deps.set(key, new Dep())
  })
  console.log(deps)

  let data_without_proxy = data

  data = new Proxy(data_without_proxy, {
    get(obj, key) {
      deps.get(key).depend();
      return obj[key];
    },
    set(obj, key, newVal) {
      obj[key] = newVal;
      deps.get(key).notyfy();
      return true;
    }
  })

  let watcher = (myFunc) => {
    target = myFunc;
    target();
    target = null;
  }
  watcher(() => {
     total = data.price * data.quantity;
  })
  watcher(() => {
     salePrice = data.price * 0.9;
  })

  console.log('total = ' + total)
  data.price = 100;
  console.log('total = ' + total)
  data.quantity = 40;
  console.log('total = ' + total)
  
  deps.set('discount', new Dep());
  data['discount'] = 5

  watcher(() => {
    salePrice = data.price - data.discount
  })
  console.log('salePrice =' + salePrice)
</script>
